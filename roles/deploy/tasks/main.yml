---
- name: Update packages
  yum:
    name: "*"
    state: latest

- name: Install dependencies
  yum:
    name: [git, wget, tar]
    state: present

- name: Create git group
  group:
    name: git
    system: yes

- name: Create git user (following official guide)
  user:
    name: git
    system: yes
    shell: /bin/bash
    comment: "Git Version Control"
    group: git
    home: /home/git
    create_home: yes

- name: Create required directory structure
  file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: "/var/lib/gitea", owner: "git", group: "git", mode: "0750" }
    - {
        path: "/var/lib/gitea/custom",
        owner: "git",
        group: "git",
        mode: "0750",
      }
    - { path: "/var/lib/gitea/data", owner: "git", group: "git", mode: "0750" }
    - { path: "/var/lib/gitea/log", owner: "git", group: "git", mode: "0750" }
    - {
        path: "/var/lib/gitea/data/gitea-repositories",
        owner: "git",
        group: "git",
        mode: "0750",
      }
    - { path: "/etc/gitea", owner: "root", group: "git", mode: "0770" }

- name: Download Gitea binary (v{{ gitea_version }})
  get_url:
    url: https://dl.gitea.com/gitea/{{ gitea_version }}/gitea-{{ gitea_version }}-linux-amd64
    dest: /usr/local/bin/gitea
    mode: "0755"
    owner: root
    group: root

- name: Generate Gitea secret key
  command: /usr/local/bin/gitea generate secret SECRET_KEY
  register: gitea_secret_key_output
  changed_when: false

- name: Generate Gitea internal token
  command: /usr/local/bin/gitea generate secret INTERNAL_TOKEN
  register: gitea_internal_token_output
  changed_when: false

- name: Set secret key fact
  set_fact:
    gitea_secret_key: "{{ gitea_secret_key_output.stdout }}"
    gitea_internal_token: "{{ gitea_internal_token_output.stdout }}"

- name: Wait for RDS MySQL to be available
  wait_for:
    host: "{{ rds_address }}"
    port: 3306
    timeout: 60
    delay: 5
  when: rds_address is defined

- name: Deploy Gitea configuration (app.ini) with RDS MySQL
  template:
    src: app.ini.j2
    dest: /etc/gitea/app.ini
    owner: root
    group: git
    mode: "0640"

- name: Create Gitea service
  template:
    src: gitea.service
    dest: /etc/systemd/system/gitea.service

- name: Set GITEA_WORK_DIR environment
  lineinfile:
    path: /etc/environment
    line: "GITEA_WORK_DIR=/var/lib/gitea"
    create: yes

- name: Initialize Gitea database (migrate)
  command: /usr/local/bin/gitea migrate -c /etc/gitea/app.ini
  become: yes
  become_user: git
  environment:
    GITEA_WORK_DIR: /var/lib/gitea
  register: gitea_migrate
  changed_when: "'Upgrade database schema to latest version' in gitea_migrate.stdout or 'Current database version is the same' not in gitea_migrate.stdout"
  failed_when: 
    - gitea_migrate.rc != 0
    - "'has already been created' not in gitea_migrate.stderr"

- name: Show migration output
  debug:
    var: gitea_migrate.stdout_lines
  when: gitea_migrate.stdout_lines is defined

- name: Enable and start Gitea service (systemd)
  systemd:
    name: gitea
    enabled: yes
    state: started
    daemon_reload: yes

- name: Wait for Gitea to start
  wait_for:
    port: 3000
    host: localhost
    delay: 10
    timeout: 120

- name: Create initial admin user (optional)
  command: >
    /usr/local/bin/gitea admin user create
    --username {{ gitea_admin_username }}
    --password {{ gitea_admin_password }}
    --email {{ gitea_admin_email }}
    --admin
    -c /etc/gitea/app.ini
  become: yes
  become_user: git
  environment:
    GITEA_WORK_DIR: /var/lib/gitea
  when:
    - gitea_admin_username is defined
    - gitea_admin_password is defined
    - gitea_admin_email is defined
  register: admin_creation
  failed_when:
    - admin_creation.rc != 0
    - "'user already exists' not in admin_creation.stderr"
  changed_when: admin_creation.rc == 0

- name: Verify Gitea service status
  systemd:
    name: gitea
  register: gitea_service_status

- name: Verify Gitea service availability
  uri:
    url: "http://localhost:3000"
    method: GET
    status_code: 200
    timeout: 10
  retries: 5
  delay: 10
  register: gitea_health

- name: Display deployment status summary
  debug:
    msg: |
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      âœ… infraGitea Deployment Complete - FULLY CONFIGURED
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      ğŸ“Š Service Status:
      - Gitea Web (3000): {{ 'HEALTHY âœ“' if gitea_health.status == 200 else 'STARTING...' }}
      - SystemD Service: {{ gitea_service_status.status.ActiveState }}
      - Version: {{ gitea_version }}
      - Auto-Start: ENABLED (boots automatically)

      ğŸ”§ Configuration:
      - Database: MySQL (RDS) - CONFIGURED âœ“
      - RDS Endpoint: {{ rds_endpoint }}
      - Database Name: {{ mysql_dbname }}
      - Install Lock: ENABLED (no web installer)
      - Secret Keys: GENERATED âœ“

      ğŸ“ Directories:
      - Working Dir: /var/lib/gitea
      - Config File: /etc/gitea/app.ini
      - Log Files: /var/lib/gitea/log
      - Repositories: /var/lib/gitea/data/gitea-repositories

      ğŸ‘¤ System User:
      - User: git
      - Group: git
      - Home: /home/git

      {% if gitea_admin_username is defined %}
      ğŸ” Admin User:
      - Username: {{ gitea_admin_username }}
      - Email: {{ gitea_admin_email }}
      - Created: {{ 'YES âœ“' if admin_creation.rc == 0 else 'Already exists' }}
      {% else %}
      ğŸ” Admin User:
      - First user to register will become admin
      - Registration is open (DISABLE_REGISTRATION = false)
      {% endif %}

      ğŸŒ Access:
      - Direct: http://{{ ansible_default_ipv4.address }}:3000
      - Via Load Balancer: (use ALB DNS when available)

      ğŸ› ï¸ Service Management:
      - Status:  sudo systemctl status gitea
      - Restart: sudo systemctl restart gitea
      - Stop:    sudo systemctl stop gitea
      - Logs:    sudo journalctl -u gitea -f

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ‰ Gitea is READY TO USE - NO MANUAL CONFIGURATION REQUIRED!
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
