---
- name: Update packages
  yum:
    name: '*'
    state: latest

- name: Install dependencies
  yum:
    name: [python3, python3-pip, git, curl]
    state: present

- name: Clone app
  git:
    repo: https://github.com/andreaendigital/CarPricePredictor-Demo.git
    dest: /home/ec2-user/app
    version: main
  become_user: ec2-user

- name: Create venv
  command: python3 -m venv /home/ec2-user/app/venv
  become_user: ec2-user

- name: Install app
  pip:
    name: /home/ec2-user/app
    virtualenv: /home/ec2-user/app/venv
    editable: yes
    extra_args: "[dev]"
  become_user: ec2-user

- name: Backend service
  template:
    src: backend.service
    dest: /etc/systemd/system/backend.service

- name: Frontend service
  template:
    src: frontend.service
    dest: /etc/systemd/system/frontend.service

- name: Start services
  systemd:
    name: "{{ item }}"
    enabled: yes
    state: started
    daemon_reload: yes
  loop: [backend, frontend]

- name: Install monitoring
  shell: |
    curl -sSL https://dl.signalfx.com/splunk-otel-collector.sh > /tmp/install.sh
    sh /tmp/install.sh --realm us1 -- PZuf3J0L2Op_Qj9hpAJzlw
  args:
    creates: /etc/otel/collector/agent_config.yaml

- name: Verify backend API endpoint availability
  uri:
    url: "http://localhost:5002/health"
    method: GET
    status_code: [200, 404]
    timeout: 10
  retries: 5
  delay: 10
  register: backend_health
  
- name: Verify frontend web service availability  
  uri:
    url: "http://localhost:3000"
    method: GET
    status_code: [200, 404]
    timeout: 10
  retries: 5
  delay: 10
  register: frontend_health

- name: Display deployment status summary
  debug:
    msg: |
      Deployment Status:
      - Backend API (5002): {{ 'HEALTHY' if backend_health.status == 200 else 'STARTING' }}
      - Frontend Web (3000): {{ 'HEALTHY' if frontend_health.status == 200 else 'STARTING' }}
      - Monitoring: Splunk OpenTelemetry Collector installed